name: Cypress E2E tests
on: [push]
jobs:
  start-test-server:
    runs-on: ubuntu-latest
    steps:
      - name: clone server repo
        uses: actions/checkout@v3
        with:
          repository: 'winstonco/sham-illustrator-server'
          path: '/'

      - name: build
        run: npm run build
        env:
          PORT: 5555
          ORIGIN: *
          OUT_OF_GAME_DRAW_ENABLED: true
          TURN_LENGTH: 3
          CLEAR_ON_END: true
          TIME_TO_GUESS: 10
          MINIMUM_PLAYERS: 3
          TRACE_LEVEL: 2

      - name: start
        run: npm start

  test:
    needs: start-test-server
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Cypress run
        uses: cypress-io/github-action@v5
        with:
          install: npm ci
          build: npm run build
          start: npm start
          wait-on: 'http://localhost:3000'
          record: true
          parallel: true
          browser: chrome
          spec: |
            cypress/e2e/**.cy.ts
        env:
          VITE_SERVER_URL: 'https://sham-illustrator-server.onrender.com'
          VITE_CHANGELOG_URL: '/changelog'
          PORT: 3000
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
